<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <title>ViperCharts/Chart</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>

    <script type="module">
      import Viper from "./index.jsx";
      import { chunk } from "lodash";

      const dataModels = {};

      const sources = { 
        BINANCE: await getDatasetsFromBinance()
      };

      async function getDatasetsFromBinance() {
        const res = await fetch("http://localhost:3000/symbols");
        const json = await res.json();

        const datasets = {};

        for (const item of json) {
          datasets[item] = {
            source: "BINANCE",
            name: item,
            modelIds: ["price"],
          };
        }

        return datasets;
      }

      let names = []

      const viper = new Viper({
        element: document.getElementById("root"),
        sources,
        dataModels,
        requestData: async (requests) => {
          for (const { source, name, modelId, timeframe } of requests) {
            if (names.includes(name)) continue;

            const res = await fetch(
              `http://localhost:3000/symbol?symbol=${name}`
            );
            const json = await res.json();

            const data = {};

            for (const item of json.data) {
              const [timestamp, open, high, low, close] = item;

              data[timestamp] = {
                open: +open,
                high: +high,
                low: +low,
                close: +close,
              };
            }

            viper.updateDataset(`${source}:${name}:${modelId}:${timeframe}`, data)
            names.push(name);
          }
        },
      })
    </script>

    <style>
      #root {
        width: 100vw;
        height: 100vh;
      }
    </style>
  </body>
</html>
