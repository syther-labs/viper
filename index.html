<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <title>ViperCharts/Chart</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>

    <script type="module">
      import Viper from "./index.jsx";

      const sources = {
        BINANCE: await getDatasetsFromBinance(),
      };

      const dataModels = {
        price: {
          id: "price",
          model: "ohlc",
          name: "Price",
          label: `%s:%n`,
        },
      };

      async function getDatasetsFromBinance() {
        const res = await fetch("http://localhost:3000/symbols");
        const json = await res.json();

        const datasets = {};

        for (const item of json) {
          datasets[item] = {
            source: "BINANCE",
            name: item,
            modelIds: ["price"],
          };
        }

        return datasets;
      }

      const viper = new Viper({
        element: document.getElementById("root"),
        sources,
        dataModels,
        requestData: async ({ source, name, timeframe, modelId, start, end }) => {
          const tf = {
            60000: "1m",
            [60000 * 5]: "5m",
            [60000 * 15]: "15m",
            [60000 * 60]: "1h",
            [60000 * 60 * 4]: "4h",
            [60000 * 60 * 24]: "1d",
          }[timeframe];

          const res = await fetch(
            `http://localhost:3000/symbol?symbol=${name}`
          );
          const json = await res.json();

          const data = {};

          for (const item of json.data) {
            const [timestamp, open, high, low, close] = item;

            data[timestamp] = {
              open: +open,
              high: +high,
              low: +low,
              close: +close,
            };
          }

          return data;
        },
      })
    </script>

    <style>
      #root {
        width: 100vw;
        height: 100vh;
      }
    </style>
  </body>
</html>
