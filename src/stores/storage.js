import Dexie from "dexie";
import { v } from "../api/api";
import chart from "../pane/chart";
import { createPane, panes } from "./panes";

export default class Storage {
  constructor() {
    this.db = new Dexie("viper");

    this.db.version(1).stores({
      templates: "++id,name,config",
    });

    this.config = v({
      activeTemplateId: 1,
    });

    this.templates = v([]);

    this._interval = null;
  }

  async init() {
    // If template is remote, dont init storage saver
    if (typeof this.config.get().activeTemplateId === "string") {
      setTimeout(() => {
        switch (this.config.get().activeTemplateId) {
          case "2udsd9":
            loadTemplateConfig(
              JSON.parse(
                `{"name":"Untitled template 1","config":{"panes":[{"type":"chart","pos":{"x":0,"y":0,"w":1,"h":6},"state":{"timeframe":60000,"name":"Relative Strength Comparison","plots":{"ayittjy7gx":{"id":"ayittjy7gx","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"BTCUSDT"},"indicatorIds":[]},"raotzu51deh":{"id":"raotzu51deh","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"ETHUSDT"},"indicatorIds":[]},"6j7ahb9q3xc":{"id":"6j7ahb9q3xc","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"BNBUSDT"},"indicatorIds":[]},"ojbbtale7uj":{"id":"ojbbtale7uj","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"BCCUSDT"},"indicatorIds":[]},"yp8arqbpfs":{"id":"yp8arqbpfs","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"NEOUSDT"},"indicatorIds":[]},"ehtqjqpxyvr":{"id":"ehtqjqpxyvr","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"LTCUSDT"},"indicatorIds":[]},"cdforn5tta":{"id":"cdforn5tta","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"QTUMUSDT"},"indicatorIds":[]},"8zfwydo38xu":{"id":"8zfwydo38xu","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"ADAUSDT"},"indicatorIds":[]},"dkz5vfsefb":{"id":"dkz5vfsefb","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"XRPUSDT"},"indicatorIds":[]},"hyf1bepj8wb":{"id":"hyf1bepj8wb","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"EOSUSDT"},"indicatorIds":[]},"kh77590lp0a":{"id":"kh77590lp0a","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"TUSDUSDT"},"indicatorIds":[]},"757pwn4bzhq":{"id":"757pwn4bzhq","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"IOTAUSDT"},"indicatorIds":[]},"90lnvy3dpv6":{"id":"90lnvy3dpv6","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"XLMUSDT"},"indicatorIds":[]},"qs5jzsybji":{"id":"qs5jzsybji","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"ONTUSDT"},"indicatorIds":[]},"bv56ocqxm2g":{"id":"bv56ocqxm2g","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"TRXUSDT"},"indicatorIds":[]},"nabxqza2uyg":{"id":"nabxqza2uyg","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"ETCUSDT"},"indicatorIds":[]},"c5k395uwpm":{"id":"c5k395uwpm","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"ICXUSDT"},"indicatorIds":[]},"0j860qx1jly":{"id":"0j860qx1jly","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"VENUSDT"},"indicatorIds":[]},"akes10u9kjg":{"id":"akes10u9kjg","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"NULSUSDT"},"indicatorIds":[]},"qz059duy2t":{"id":"qz059duy2t","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"VETUSDT"},"indicatorIds":[]},"nzazdplwgh9":{"id":"nzazdplwgh9","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"PAXUSDT"},"indicatorIds":[]},"ca41iiibdcv":{"id":"ca41iiibdcv","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"BCHABCUSDT"},"indicatorIds":[]},"kmz8kcvaax":{"id":"kmz8kcvaax","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"BCHSVUSDT"},"indicatorIds":[]},"32d8i82654y":{"id":"32d8i82654y","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"USDCUSDT"},"indicatorIds":[]},"t352reif0t":{"id":"t352reif0t","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"LINKUSDT"},"indicatorIds":[]},"oqmuhfmnp3m":{"id":"oqmuhfmnp3m","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"WAVESUSDT"},"indicatorIds":[]},"raanfta429p":{"id":"raanfta429p","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"BTTUSDT"},"indicatorIds":[]},"fnvrcep2a7b":{"id":"fnvrcep2a7b","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"USDSUSDT"},"indicatorIds":[]},"3viio1hxs1e":{"id":"3viio1hxs1e","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"ONGUSDT"},"indicatorIds":[]},"ta1a9e15mhn":{"id":"ta1a9e15mhn","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"HOTUSDT"},"indicatorIds":[]},"499bxa4yfr8":{"id":"499bxa4yfr8","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"ZILUSDT"},"indicatorIds":[]},"8bhuxhq2bc":{"id":"8bhuxhq2bc","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"ZRXUSDT"},"indicatorIds":[]},"rw3nl24hcw":{"id":"rw3nl24hcw","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"FETUSDT"},"indicatorIds":[]},"15pg8yjvzgz":{"id":"15pg8yjvzgz","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"BATUSDT"},"indicatorIds":[]},"ucawc1mbdw":{"id":"ucawc1mbdw","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"XMRUSDT"},"indicatorIds":[]},"c1zn3ks42zb":{"id":"c1zn3ks42zb","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"ZECUSDT"},"indicatorIds":[]},"yl59him3ssq":{"id":"yl59him3ssq","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"IOSTUSDT"},"indicatorIds":[]},"18ro1fi8x4s":{"id":"18ro1fi8x4s","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"CELRUSDT"},"indicatorIds":[]},"2nmfyfl7nvt":{"id":"2nmfyfl7nvt","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"DASHUSDT"},"indicatorIds":[]},"eqig6ztvf25":{"id":"eqig6ztvf25","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"NANOUSDT"},"indicatorIds":[]},"9gt9fy2n0rf":{"id":"9gt9fy2n0rf","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"OMGUSDT"},"indicatorIds":[]},"byowsiwj0fl":{"id":"byowsiwj0fl","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"THETAUSDT"},"indicatorIds":[]},"3kd3x1gnki2":{"id":"3kd3x1gnki2","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"ENJUSDT"},"indicatorIds":[]},"u8k4px25kg":{"id":"u8k4px25kg","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"MITHUSDT"},"indicatorIds":[]},"rey18kfsvdb":{"id":"rey18kfsvdb","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"MATICUSDT"},"indicatorIds":[]},"nbpu6q7wq1c":{"id":"nbpu6q7wq1c","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"ATOMUSDT"},"indicatorIds":[]},"70qy9kmnkbp":{"id":"70qy9kmnkbp","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"TFUELUSDT"},"indicatorIds":[]},"avihhwb148o":{"id":"avihhwb148o","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"ONEUSDT"},"indicatorIds":[]},"y533hc0vvcc":{"id":"y533hc0vvcc","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"FTMUSDT"},"indicatorIds":[]},"yh9szzsvqai":{"id":"yh9szzsvqai","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"ALGOUSDT"},"indicatorIds":[]},"ahalz9onb2d":{"id":"ahalz9onb2d","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"USDSBUSDT"},"indicatorIds":[]},"cxhbd5rinsc":{"id":"cxhbd5rinsc","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"GTOUSDT"},"indicatorIds":[]},"z095mbbwr4k":{"id":"z095mbbwr4k","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"ERDUSDT"},"indicatorIds":[]},"yec9tgsmmka":{"id":"yec9tgsmmka","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"DOGEUSDT"},"indicatorIds":[]},"7cpczux4gb7":{"id":"7cpczux4gb7","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"DUSKUSDT"},"indicatorIds":[]},"6qgajy4e4h3":{"id":"6qgajy4e4h3","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"ANKRUSDT"},"indicatorIds":[]},"qzqmxiyoqp":{"id":"qzqmxiyoqp","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"WINUSDT"},"indicatorIds":[]},"umm4nohk55k":{"id":"umm4nohk55k","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"COSUSDT"},"indicatorIds":[]},"t5ekln9e5g":{"id":"t5ekln9e5g","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"NPXSUSDT"},"indicatorIds":[]},"nsu02wh0gxl":{"id":"nsu02wh0gxl","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"COCOSUSDT"},"indicatorIds":[]},"3aeckop9qto":{"id":"3aeckop9qto","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"MTLUSDT"},"indicatorIds":[]},"7ojzfiv19gr":{"id":"7ojzfiv19gr","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"TOMOUSDT"},"indicatorIds":[]},"1bumsng3ct8":{"id":"1bumsng3ct8","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"PERLUSDT"},"indicatorIds":[]},"me3uol3onl":{"id":"me3uol3onl","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"DENTUSDT"},"indicatorIds":[]},"pwg1hsr4ci":{"id":"pwg1hsr4ci","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"MFTUSDT"},"indicatorIds":[]},"jltcn2g5x8":{"id":"jltcn2g5x8","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"KEYUSDT"},"indicatorIds":[]},"ynyhcr5txm":{"id":"ynyhcr5txm","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"STORMUSDT"},"indicatorIds":[]},"1vag5dyswgf":{"id":"1vag5dyswgf","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"DOCKUSDT"},"indicatorIds":[]},"tibe76i4ocq":{"id":"tibe76i4ocq","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"WANUSDT"},"indicatorIds":[]},"c6c7cvyzit7":{"id":"c6c7cvyzit7","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"FUNUSDT"},"indicatorIds":[]},"vveis8i973":{"id":"vveis8i973","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"CVCUSDT"},"indicatorIds":[]},"5i84uw5weve":{"id":"5i84uw5weve","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"CHZUSDT"},"indicatorIds":[]},"z4r18m2eejq":{"id":"z4r18m2eejq","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"BANDUSDT"},"indicatorIds":[]},"sokh7rvfrob":{"id":"sokh7rvfrob","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"BUSDUSDT"},"indicatorIds":[]},"jbvjs496ghf":{"id":"jbvjs496ghf","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"BEAMUSDT"},"indicatorIds":[]},"03fqmb7ry5mv":{"id":"03fqmb7ry5mv","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"XTZUSDT"},"indicatorIds":[]},"qsufe3ebggl":{"id":"qsufe3ebggl","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"RENUSDT"},"indicatorIds":[]},"b99bfl3aivn":{"id":"b99bfl3aivn","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"RVNUSDT"},"indicatorIds":[]},"rsnhtkp9kih":{"id":"rsnhtkp9kih","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"HCUSDT"},"indicatorIds":[]},"tqh7pea0gsj":{"id":"tqh7pea0gsj","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"HBARUSDT"},"indicatorIds":[]},"rda19ybwpmi":{"id":"rda19ybwpmi","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"NKNUSDT"},"indicatorIds":[]},"8z7sjdrqzqc":{"id":"8z7sjdrqzqc","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"STXUSDT"},"indicatorIds":[]},"4a6we8wurvi":{"id":"4a6we8wurvi","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"KAVAUSDT"},"indicatorIds":[]},"z9udmkapyvq":{"id":"z9udmkapyvq","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"ARPAUSDT"},"indicatorIds":[]},"ucq2o6uik2":{"id":"ucq2o6uik2","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"IOTXUSDT"},"indicatorIds":[]},"d0ft0s9697k":{"id":"d0ft0s9697k","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"RLCUSDT"},"indicatorIds":[]},"9v27wsku4c5":{"id":"9v27wsku4c5","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"MCOUSDT"},"indicatorIds":[]},"cg7eoskq226":{"id":"cg7eoskq226","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"CTXCUSDT"},"indicatorIds":[]},"gu23ov3ds6a":{"id":"gu23ov3ds6a","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"BCHUSDT"},"indicatorIds":[]},"sa4kavih8xo":{"id":"sa4kavih8xo","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"TROYUSDT"},"indicatorIds":[]},"kkhlz204xye":{"id":"kkhlz204xye","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"VITEUSDT"},"indicatorIds":[]},"apwq70kupgv":{"id":"apwq70kupgv","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"FTTUSDT"},"indicatorIds":[]},"hk47bduwxa":{"id":"hk47bduwxa","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"EURUSDT"},"indicatorIds":[]},"nnf84ri87kl":{"id":"nnf84ri87kl","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"OGNUSDT"},"indicatorIds":[]},"9xysarautck":{"id":"9xysarautck","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"DREPUSDT"},"indicatorIds":[]},"b1hu5m4a3sb":{"id":"b1hu5m4a3sb","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"BULLUSDT"},"indicatorIds":[]},"l8wf0hr6wwd":{"id":"l8wf0hr6wwd","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"BEARUSDT"},"indicatorIds":[]},"h9xk8j13ame":{"id":"h9xk8j13ame","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"ETHBULLUSDT"},"indicatorIds":[]},"leitpv5w1x":{"id":"leitpv5w1x","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"ETHBEARUSDT"},"indicatorIds":[]},"1214rewirmtk":{"id":"1214rewirmtk","type":"DataModelGroup","visible":true,"dataset":{"source":"BINANCE","name":"TCTUSDT"},"indicatorIds":[]}},"indicators":{"3":{"indicatorId":"line","setId":"3","renderingQueueId":"3","color":[0.8579249848523862,0.6513310998470736,0.79813440950225,1],"plotId":"ayittjy7gx","model":"price","visible":true,"layerId":"2"},"4":{"indicatorId":"line","setId":"4","renderingQueueId":"4","color":[0.6803295812506798,0.4597461380753789,0.19412492688887584,1],"plotId":"raotzu51deh","model":"price","visible":true,"layerId":"2"},"5":{"indicatorId":"line","setId":"5","renderingQueueId":"5","color":[0.3989709234644634,0.8175299473142867,0.09870763783678882,1],"plotId":"6j7ahb9q3xc","model":"price","visible":true,"layerId":"2"},"6":{"indicatorId":"line","setId":"6","renderingQueueId":"6","color":[0.6974612572565007,0.4109120910516506,0.07876823078379824,1],"plotId":"ojbbtale7uj","model":"price","visible":true,"layerId":"2"},"7":{"indicatorId":"line","setId":"7","renderingQueueId":"7","color":[0.9593201605933739,0.6627059730114291,0.9635058243755428,1],"plotId":"yp8arqbpfs","model":"price","visible":true,"layerId":"2"},"8":{"indicatorId":"line","setId":"8","renderingQueueId":"8","color":[0.9353753267795897,0.9087346197510404,0.3294654281377203,1],"plotId":"ehtqjqpxyvr","model":"price","visible":true,"layerId":"2"},"9":{"indicatorId":"line","setId":"9","renderingQueueId":"9","color":[0.027397091450423572,0.4078973217308559,0.5590373130793151,1],"plotId":"cdforn5tta","model":"price","visible":true,"layerId":"2"},"10":{"indicatorId":"line","setId":"10","renderingQueueId":"10","color":[0.7837683926147936,0.8548392616685245,0.35442629865442354,1],"plotId":"8zfwydo38xu","model":"price","visible":true,"layerId":"2"},"11":{"indicatorId":"line","setId":"11","renderingQueueId":"11","color":[0.34310462790265506,0.7209183054642108,0.12035846038649956,1],"plotId":"dkz5vfsefb","model":"price","visible":true,"layerId":"2"},"12":{"indicatorId":"line","setId":"12","renderingQueueId":"12","color":[0.9685023042143881,0.6332676424959616,0.13262789883058002,1],"plotId":"hyf1bepj8wb","model":"price","visible":true,"layerId":"2"},"13":{"indicatorId":"line","setId":"13","renderingQueueId":"13","color":[0.6552344180630263,0.8274048201524906,0.0750419382683627,1],"plotId":"kh77590lp0a","model":"price","visible":true,"layerId":"2"},"14":{"indicatorId":"line","setId":"14","renderingQueueId":"14","color":[0.7690601134737285,0.4038170578038496,0.7635661815162587,1],"plotId":"757pwn4bzhq","model":"price","visible":true,"layerId":"2"},"15":{"indicatorId":"line","setId":"15","renderingQueueId":"15","color":[0.828718838786975,0.21060988643868184,0.7492991899815609,1],"plotId":"90lnvy3dpv6","model":"price","visible":true,"layerId":"2"},"16":{"indicatorId":"line","setId":"16","renderingQueueId":"16","color":[0.023891427057927794,0.38361972775217135,0.9345904045771625,1],"plotId":"qs5jzsybji","model":"price","visible":true,"layerId":"2"},"17":{"indicatorId":"line","setId":"17","renderingQueueId":"17","color":[0.8421019596453627,0.0645659463130821,0.7216084598033905,1],"plotId":"bv56ocqxm2g","model":"price","visible":true,"layerId":"2"},"18":{"indicatorId":"line","setId":"18","renderingQueueId":"18","color":[0.04171164980646269,0.7328235584937759,0.7168818743412313,1],"plotId":"nabxqza2uyg","model":"price","visible":true,"layerId":"2"},"19":{"indicatorId":"line","setId":"19","renderingQueueId":"19","color":[0.3310455363836442,0.46886261141633434,0.7447187388860521,1],"plotId":"c5k395uwpm","model":"price","visible":true,"layerId":"2"},"20":{"indicatorId":"line","setId":"20","renderingQueueId":"20","color":[0.6387225578816256,0.3245713999736273,0.25361796490538113,1],"plotId":"0j860qx1jly","model":"price","visible":true,"layerId":"2"},"21":{"indicatorId":"line","setId":"21","renderingQueueId":"21","color":[0.5924707840639489,0.7085229764576237,0.3239932582887446,1],"plotId":"akes10u9kjg","model":"price","visible":true,"layerId":"2"},"22":{"indicatorId":"line","setId":"22","renderingQueueId":"22","color":[0.5518395892244068,0.6121420747414554,0.03492976399352332,1],"plotId":"qz059duy2t","model":"price","visible":true,"layerId":"2"},"23":{"indicatorId":"line","setId":"23","renderingQueueId":"23","color":[0.32104552480385284,0.2945665807752216,0.8959491234351906,1],"plotId":"nzazdplwgh9","model":"price","visible":true,"layerId":"2"},"24":{"indicatorId":"line","setId":"24","renderingQueueId":"24","color":[0.09754835258121042,0.829617092107308,0.572581334996259,1],"plotId":"ca41iiibdcv","model":"price","visible":true,"layerId":"2"},"25":{"indicatorId":"line","setId":"25","renderingQueueId":"25","color":[0.6894497106086916,0.4798613992875109,0.33225662990540594,1],"plotId":"kmz8kcvaax","model":"price","visible":true,"layerId":"2"},"26":{"indicatorId":"line","setId":"26","renderingQueueId":"26","color":[0.12940092544313897,0.03943947974033546,0.7783650068925543,1],"plotId":"32d8i82654y","model":"price","visible":true,"layerId":"2"},"27":{"indicatorId":"line","setId":"27","renderingQueueId":"27","color":[0.15823829260815203,0.8450243248173572,0.8269519970682886,1],"plotId":"t352reif0t","model":"price","visible":true,"layerId":"2"},"28":{"indicatorId":"line","setId":"28","renderingQueueId":"28","color":[0.6976542934444112,0.46701089307655574,0.9892921710076941,1],"plotId":"oqmuhfmnp3m","model":"price","visible":true,"layerId":"2"},"29":{"indicatorId":"line","setId":"29","renderingQueueId":"29","color":[0.5463262996696499,0.9013241978293207,0.6473334770830059,1],"plotId":"raanfta429p","model":"price","visible":true,"layerId":"2"},"30":{"indicatorId":"line","setId":"30","renderingQueueId":"30","color":[0.10398922390360466,0.03301732450742412,0.575479687072296,1],"plotId":"fnvrcep2a7b","model":"price","visible":true,"layerId":"2"},"31":{"indicatorId":"line","setId":"31","renderingQueueId":"31","color":[0.2791139829540039,0.08053074875317079,0.5100703022807522,1],"plotId":"3viio1hxs1e","model":"price","visible":true,"layerId":"2"},"32":{"indicatorId":"line","setId":"32","renderingQueueId":"32","color":[0.5869143356899009,0.9553114481323206,0.6965405720384645,1],"plotId":"ta1a9e15mhn","model":"price","visible":true,"layerId":"2"},"33":{"indicatorId":"line","setId":"33","renderingQueueId":"33","color":[0.5534266530252889,0.2642519355534958,0.6386123213290096,1],"plotId":"499bxa4yfr8","model":"price","visible":true,"layerId":"2"},"34":{"indicatorId":"line","setId":"34","renderingQueueId":"34","color":[0.6151402544210465,0.656620013932304,0.14309466711742114,1],"plotId":"8bhuxhq2bc","model":"price","visible":true,"layerId":"2"},"35":{"indicatorId":"line","setId":"35","renderingQueueId":"35","color":[0.661828895922234,0.6324358829257677,0.1978637250976556,1],"plotId":"rw3nl24hcw","model":"price","visible":true,"layerId":"2"},"36":{"indicatorId":"line","setId":"36","renderingQueueId":"36","color":[0.010584648477217407,0.8443129777879046,0.6057797975468455,1],"plotId":"15pg8yjvzgz","model":"price","visible":true,"layerId":"2"},"37":{"indicatorId":"line","setId":"37","renderingQueueId":"37","color":[0.1803467405432575,0.748995279921453,0.4111916985539259,1],"plotId":"ucawc1mbdw","model":"price","visible":true,"layerId":"2"},"38":{"indicatorId":"line","setId":"38","renderingQueueId":"38","color":[0.5976407590337622,0.9704192234094497,0.5081500869813969,1],"plotId":"c1zn3ks42zb","model":"price","visible":true,"layerId":"2"},"39":{"indicatorId":"line","setId":"39","renderingQueueId":"39","color":[0.2410642297764678,0.3607554101868262,0.7462835157644643,1],"plotId":"yl59him3ssq","model":"price","visible":true,"layerId":"2"},"40":{"indicatorId":"line","setId":"40","renderingQueueId":"40","color":[0.7214895367675287,0.7718691724298745,0.3324008175163222,1],"plotId":"18ro1fi8x4s","model":"price","visible":true,"layerId":"2"},"41":{"indicatorId":"line","setId":"41","renderingQueueId":"41","color":[0.012780762531594547,0.8494382684698094,0.5568129218781288,1],"plotId":"2nmfyfl7nvt","model":"price","visible":true,"layerId":"2"},"42":{"indicatorId":"line","setId":"42","renderingQueueId":"42","color":[0.6758464626216076,0.34151586320133265,0.15888593474859602,1],"plotId":"eqig6ztvf25","model":"price","visible":true,"layerId":"2"},"43":{"indicatorId":"line","setId":"43","renderingQueueId":"43","color":[0.7354487105638201,0.8227379833125954,0.950563742547696,1],"plotId":"9gt9fy2n0rf","model":"price","visible":true,"layerId":"2"},"44":{"indicatorId":"line","setId":"44","renderingQueueId":"44","color":[0.29208917104672616,0.7089113864155911,0.7960533147983564,1],"plotId":"byowsiwj0fl","model":"price","visible":true,"layerId":"2"},"45":{"indicatorId":"line","setId":"45","renderingQueueId":"45","color":[0.7216919843473906,0.739208134496099,0.30458739773350274,1],"plotId":"3kd3x1gnki2","model":"price","visible":true,"layerId":"2"},"46":{"indicatorId":"line","setId":"46","renderingQueueId":"46","color":[0.4449437371135123,0.6432313799857694,0.457247212651674,1],"plotId":"u8k4px25kg","model":"price","visible":true,"layerId":"2"},"47":{"indicatorId":"line","setId":"47","renderingQueueId":"47","color":[0.24659250425862855,0.7432478036797585,0.9895365816625423,1],"plotId":"rey18kfsvdb","model":"price","visible":true,"layerId":"2"},"48":{"indicatorId":"line","setId":"48","renderingQueueId":"48","color":[0.25024968947784876,0.022100922562718894,0.21094709063021932,1],"plotId":"nbpu6q7wq1c","model":"price","visible":true,"layerId":"2"},"49":{"indicatorId":"line","setId":"49","renderingQueueId":"49","color":[0.9309443062811922,0.34757653103351815,0.6989660282991994,1],"plotId":"70qy9kmnkbp","model":"price","visible":true,"layerId":"2"},"50":{"indicatorId":"line","setId":"50","renderingQueueId":"50","color":[0.7645019981436139,0.9756099046662046,0.7039081520719828,1],"plotId":"avihhwb148o","model":"price","visible":true,"layerId":"2"},"51":{"indicatorId":"line","setId":"51","renderingQueueId":"51","color":[0.5928521082273845,0.20926532531816466,0.31035374716936226,1],"plotId":"y533hc0vvcc","model":"price","visible":true,"layerId":"2"},"52":{"indicatorId":"line","setId":"52","renderingQueueId":"52","color":[0.6765906700565363,0.010459959695136911,0.8090124579679088,1],"plotId":"yh9szzsvqai","model":"price","visible":true,"layerId":"2"},"53":{"indicatorId":"line","setId":"53","renderingQueueId":"53","color":[0.549856769095427,0.2695215897731511,0.5831098991818675,1],"plotId":"ahalz9onb2d","model":"price","visible":true,"layerId":"2"},"54":{"indicatorId":"line","setId":"54","renderingQueueId":"54","color":[0.8707014300569329,0.46154821597133244,0.2901385885354437,1],"plotId":"cxhbd5rinsc","model":"price","visible":true,"layerId":"2"},"55":{"indicatorId":"line","setId":"55","renderingQueueId":"55","color":[0.9198021274863297,0.90618842726038,0.7817910633177969,1],"plotId":"z095mbbwr4k","model":"price","visible":true,"layerId":"2"},"56":{"indicatorId":"line","setId":"56","renderingQueueId":"56","color":[0.6901091803704476,0.07989745926267955,0.13983112903495432,1],"plotId":"yec9tgsmmka","model":"price","visible":true,"layerId":"2"},"57":{"indicatorId":"line","setId":"57","renderingQueueId":"57","color":[0.1627477163944009,0.3589570145028189,0.09658472750141667,1],"plotId":"7cpczux4gb7","model":"price","visible":true,"layerId":"2"},"58":{"indicatorId":"line","setId":"58","renderingQueueId":"58","color":[0.9315382751994603,0.8853817962359751,0.4807607493167989,1],"plotId":"6qgajy4e4h3","model":"price","visible":true,"layerId":"2"},"59":{"indicatorId":"line","setId":"59","renderingQueueId":"59","color":[0.18738491857781314,0.7130312388074747,0.9968129873126088,1],"plotId":"qzqmxiyoqp","model":"price","visible":true,"layerId":"2"},"60":{"indicatorId":"line","setId":"60","renderingQueueId":"60","color":[0.40791075593507475,0.05720864742820275,0.6397888385707793,1],"plotId":"umm4nohk55k","model":"price","visible":true,"layerId":"2"},"61":{"indicatorId":"line","setId":"61","renderingQueueId":"61","color":[0.827232788837146,0.47482033631728426,0.7235796542163753,1],"plotId":"t5ekln9e5g","model":"price","visible":true,"layerId":"2"},"62":{"indicatorId":"line","setId":"62","renderingQueueId":"62","color":[0.5577235635332793,0.23610776030920722,0.30254852761026263,1],"plotId":"nsu02wh0gxl","model":"price","visible":true,"layerId":"2"},"63":{"indicatorId":"line","setId":"63","renderingQueueId":"63","color":[0.023320727394139595,0.6428538512478494,0.017523961648143738,1],"plotId":"3aeckop9qto","model":"price","visible":true,"layerId":"2"},"64":{"indicatorId":"line","setId":"64","renderingQueueId":"64","color":[0.1423223319435205,0.9567926199846164,0.16553139453625532,1],"plotId":"7ojzfiv19gr","model":"price","visible":true,"layerId":"2"},"65":{"indicatorId":"line","setId":"65","renderingQueueId":"65","color":[0.5151056759918531,0.8460484385847022,0.6134248703057372,1],"plotId":"1bumsng3ct8","model":"price","visible":true,"layerId":"2"},"66":{"indicatorId":"line","setId":"66","renderingQueueId":"66","color":[0.9873266385444268,0.6893464039658597,0.5370515291564073,1],"plotId":"me3uol3onl","model":"price","visible":true,"layerId":"2"},"67":{"indicatorId":"line","setId":"67","renderingQueueId":"67","color":[0.5453992845865714,0.19651026463995325,0.7883011624788929,1],"plotId":"pwg1hsr4ci","model":"price","visible":true,"layerId":"2"},"68":{"indicatorId":"line","setId":"68","renderingQueueId":"68","color":[0.9605725708146458,0.3768789660017673,0.9478774551451201,1],"plotId":"jltcn2g5x8","model":"price","visible":true,"layerId":"2"},"69":{"indicatorId":"line","setId":"69","renderingQueueId":"69","color":[0.25440400104089367,0.7137313346718612,0.9835826216075236,1],"plotId":"ynyhcr5txm","model":"price","visible":true,"layerId":"2"},"70":{"indicatorId":"line","setId":"70","renderingQueueId":"70","color":[0.48842838196612925,0.4830584381527634,0.42489927001248984,1],"plotId":"1vag5dyswgf","model":"price","visible":true,"layerId":"2"},"71":{"indicatorId":"line","setId":"71","renderingQueueId":"71","color":[0.24303212093173387,0.2106368470536628,0.4054458644538437,1],"plotId":"tibe76i4ocq","model":"price","visible":true,"layerId":"2"},"72":{"indicatorId":"line","setId":"72","renderingQueueId":"72","color":[0.9393473517828848,0.873821157722128,0.13765192635503998,1],"plotId":"c6c7cvyzit7","model":"price","visible":true,"layerId":"2"},"73":{"indicatorId":"line","setId":"73","renderingQueueId":"73","color":[0.8119101629017524,0.6170667507864047,0.7496124421158961,1],"plotId":"vveis8i973","model":"price","visible":true,"layerId":"2"},"74":{"indicatorId":"line","setId":"74","renderingQueueId":"74","color":[0.5759259124888754,0.04580770778308252,0.569643978497999,1],"plotId":"5i84uw5weve","model":"price","visible":true,"layerId":"2"},"75":{"indicatorId":"line","setId":"75","renderingQueueId":"75","color":[0.5198428124796166,0.08280861835018816,0.9462855319017498,1],"plotId":"z4r18m2eejq","model":"price","visible":true,"layerId":"2"},"76":{"indicatorId":"line","setId":"76","renderingQueueId":"76","color":[0.3244033850985737,0.8890190551528856,0.3555319214331314,1],"plotId":"sokh7rvfrob","model":"price","visible":true,"layerId":"2"},"77":{"indicatorId":"line","setId":"77","renderingQueueId":"77","color":[0.17776915348917277,0.7653776672063162,0.800982134127141,1],"plotId":"jbvjs496ghf","model":"price","visible":true,"layerId":"2"},"78":{"indicatorId":"line","setId":"78","renderingQueueId":"78","color":[0.014270119629246514,0.7968515920953139,0.012646173777967507,1],"plotId":"03fqmb7ry5mv","model":"price","visible":true,"layerId":"2"},"79":{"indicatorId":"line","setId":"79","renderingQueueId":"79","color":[0.04258694288903353,0.5458329785795233,0.6011696913061368,1],"plotId":"qsufe3ebggl","model":"price","visible":true,"layerId":"2"},"80":{"indicatorId":"line","setId":"80","renderingQueueId":"80","color":[0.6256536998213227,0.01906780492091631,0.439257124773591,1],"plotId":"b99bfl3aivn","model":"price","visible":true,"layerId":"2"},"81":{"indicatorId":"line","setId":"81","renderingQueueId":"81","color":[0.4542269509645873,0.9929385596929701,0.7404024861503902,1],"plotId":"rsnhtkp9kih","model":"price","visible":true,"layerId":"2"},"82":{"indicatorId":"line","setId":"82","renderingQueueId":"82","color":[0.519948266659013,0.5355363481985438,0.29452804075397543,1],"plotId":"tqh7pea0gsj","model":"price","visible":true,"layerId":"2"},"83":{"indicatorId":"line","setId":"83","renderingQueueId":"83","color":[0.5730709927265456,0.9577318558663199,0.8278329020645676,1],"plotId":"rda19ybwpmi","model":"price","visible":true,"layerId":"2"},"84":{"indicatorId":"line","setId":"84","renderingQueueId":"84","color":[0.11814685628218302,0.618064889751343,0.6755767077948391,1],"plotId":"8z7sjdrqzqc","model":"price","visible":true,"layerId":"2"},"85":{"indicatorId":"line","setId":"85","renderingQueueId":"85","color":[0.27750323343920646,0.8999047480227715,0.30175923377485026,1],"plotId":"4a6we8wurvi","model":"price","visible":true,"layerId":"2"},"86":{"indicatorId":"line","setId":"86","renderingQueueId":"86","color":[0.4146765055020014,0.303552309136792,0.5148411562278556,1],"plotId":"z9udmkapyvq","model":"price","visible":true,"layerId":"2"},"87":{"indicatorId":"line","setId":"87","renderingQueueId":"87","color":[0.4614711314275155,0.4713045974202623,0.00009847363231019202,1],"plotId":"ucq2o6uik2","model":"price","visible":true,"layerId":"2"},"88":{"indicatorId":"line","setId":"88","renderingQueueId":"88","color":[0.03140832984865871,0.9037872525950328,0.47105247888688306,1],"plotId":"d0ft0s9697k","model":"price","visible":true,"layerId":"2"},"89":{"indicatorId":"line","setId":"89","renderingQueueId":"89","color":[0.8884276538900093,0.2619264500732641,0.8417922813050664,1],"plotId":"9v27wsku4c5","model":"price","visible":true,"layerId":"2"},"90":{"indicatorId":"line","setId":"90","renderingQueueId":"90","color":[0.8394122053472259,0.06577292909504795,0.1842222107161826,1],"plotId":"cg7eoskq226","model":"price","visible":true,"layerId":"2"},"91":{"indicatorId":"line","setId":"91","renderingQueueId":"91","color":[0.8540860057768689,0.9017400327824163,0.27236276574786333,1],"plotId":"gu23ov3ds6a","model":"price","visible":true,"layerId":"2"},"92":{"indicatorId":"line","setId":"92","renderingQueueId":"92","color":[0.9387543008780044,0.25197723036768704,0.7938064913707399,1],"plotId":"sa4kavih8xo","model":"price","visible":true,"layerId":"2"},"93":{"indicatorId":"line","setId":"93","renderingQueueId":"93","color":[0.36500038713065974,0.8734918466342463,0.7786784496760999,1],"plotId":"kkhlz204xye","model":"price","visible":true,"layerId":"2"},"94":{"indicatorId":"line","setId":"94","renderingQueueId":"94","color":[0.6171004080145925,0.41223657534901337,0.5299243274411651,1],"plotId":"apwq70kupgv","model":"price","visible":true,"layerId":"2"},"95":{"indicatorId":"line","setId":"95","renderingQueueId":"95","color":[0.5570449386110625,0.864424990709014,0.6434920986271757,1],"plotId":"hk47bduwxa","model":"price","visible":true,"layerId":"2"},"96":{"indicatorId":"line","setId":"96","renderingQueueId":"96","color":[0.6671346614687248,0.9461857200783181,0.9967970437689317,1],"plotId":"nnf84ri87kl","model":"price","visible":true,"layerId":"2"},"97":{"indicatorId":"line","setId":"97","renderingQueueId":"97","color":[0.6112151159392467,0.8778683224847661,0.22997132228234296,1],"plotId":"9xysarautck","model":"price","visible":true,"layerId":"2"},"98":{"indicatorId":"line","setId":"98","renderingQueueId":"98","color":[0.30044152871578556,0.6169785048796013,0.8240672368220556,1],"plotId":"b1hu5m4a3sb","model":"price","visible":true,"layerId":"2"},"99":{"indicatorId":"line","setId":"99","renderingQueueId":"99","color":[0.5839042139969537,0.7496785060852595,0.8612625556633564,1],"plotId":"l8wf0hr6wwd","model":"price","visible":true,"layerId":"2"},"100":{"indicatorId":"line","setId":"100","renderingQueueId":"100","color":[0.9689330360710147,0.13761057440084246,0.5862130285894376,1],"plotId":"h9xk8j13ame","model":"price","visible":true,"layerId":"2"},"101":{"indicatorId":"line","setId":"101","renderingQueueId":"101","color":[0.503541252466803,0.35440915284355534,0.3558507567722595,1],"plotId":"leitpv5w1x","model":"price","visible":true,"layerId":"2"},"102":{"indicatorId":"line","setId":"102","renderingQueueId":"102","color":[0.3005793276155613,0.7020349181443852,0.15936241648487548,1],"plotId":"1214rewirmtk","model":"price","visible":true,"layerId":"2"}},"ranges":{"x":{"start":1667925060000,"end":1667934060000},"y":{"2":{"id":"2","heightUnit":10,"lockedYScale":true,"visible":true,"fullscreen":true,"scaleType":1,"indicatorIds":[],"range":{"min":-58.109606036483115,"max":19.866944157449907}}}},"pixelsPerElement":5}}]},"id":1}`
              )
            );
            break;
        }
      });

      return;
    }

    this._interval = setInterval(this.snapshotState.bind(this), 5000);

    // Load storage locally
    let config = localStorage.getItem("config");
    if (config) {
      config = JSON.parse(config);
      this.config.set(config);

      // Load template by id if exists
      const template = await this.db.templates
        .where("id")
        .equals(config.activeTemplateId)
        .toArray();

      // Create a new pane for each pane
      if (template && template[0]) {
        loadTemplateConfig(template[0]);
      }
    }
  }

  async save(id, name, config) {
    // Check if template exists at id
    const rows = await this.db.templates.where("id").equals(id).toArray();
    const row = rows[0];

    if (row) {
      // If so, update it
      await this.db.templates.update(id, { name, config });
    } else {
      // If not, create it
      await this.db.templates.add({ name, config });
    }

    return await this.db.templates.orderBy("id").last();
  }

  async delete(id) {
    await this.db.templates.delete(id);
  }

  snapshotState() {
    const config = this.config.get();

    // If tempalte is string (remote template id) dont save locally
    if (typeof config.activeTemplateId === "string") {
      return;
    }

    const snapshot = {
      config,
      panes: [],
    };

    // Loop through all panes and add to state
    const panesArr = Object.values(panes.get());
    for (const pane of panesArr) {
      // Copy pane config and state

      const { type, pos, app } = pane.get();
      const state = copyReactiveState(type, app.state);

      snapshot.panes.push({
        type,
        pos,
        state,
      });
    }

    // Save template to IndexedDB
    this.save(config.activeTemplateId, "Untitled template 1", {
      panes: snapshot.panes,
    });

    // Save global config to LocalStorage
    localStorage.setItem("config", JSON.stringify(config));
  }

  destroy() {
    if (this._interval) clearInterval(this._interval);
  }
}

export function copyReactiveState(type, state) {
  const convertObj = obj => {
    if (Array.isArray(obj)) obj = [...obj];
    else obj = { ...obj };

    // Loop through every paramater in object
    for (const key in obj) {
      // If object has get and set method
      const { get } = obj[key];

      if (key === "indicatorIds") {
        obj[key] = [];
        continue;
      }

      if (typeof get === "function") {
        obj[key] = get();
      }

      if (typeof obj[key] === "object") {
        obj[key] = convertObj(obj[key]);
      }
    }

    return obj;
  };

  return convertObj(state);
}

function loadTemplateConfig(template) {
  for (const pane of template.config.panes) {
    switch (pane.type) {
      case "chart":
        createPane(chart, {
          pos: pane.pos,
          state: pane.state,
        });
        break;
    }
  }
}
